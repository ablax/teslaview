<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TeslaCam Video Player</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="View, edit, and create custom clips from TeslaCam videos from Dashcam or Sentry Mode">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TeslaCam">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- iOS specific meta tags -->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/icon-76x76.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-video"></i> TeslaCam Video Player</h1>
            <p>Easily view TeslaCam videos from Dashcam or Sentry Mode</p>
        </header>

        <!-- File Selection Area -->
        <div class="file-selection" id="fileSelection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-content">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Select TeslaCam Files</h3>
                    <p>Drag and drop folders or video files here, or use the buttons below</p>
                    <p class="subtitle">Supports: TeslaCam, RecentClips, SavedClips, SentryClips directories</p>
                    <input type="file" id="fileInput" multiple accept="video/*" style="display: none;" webkitdirectory directory>
                    <input type="file" id="dirInput" webkitdirectory directory style="display: none;">
                    <div class="button-group">
                        <button class="browse-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-file-video"></i> Select Video Files
                        </button>
                        <button class="browse-btn secondary" onclick="document.getElementById('dirInput').click()">
                            <i class="fas fa-folder-open"></i> Select Directory
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Player Area -->
        <div class="video-container" id="videoContainer" style="display: none;">
            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <button id="playPauseBtn" class="control-btn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="prevBtn" class="control-btn">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="nextBtn" class="control-btn">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <div class="control-group">
                    <span class="speed-label">Speed:</span>
                    <button class="speed-btn" data-speed="0.5">0.5x</button>
                    <button class="speed-btn active" data-speed="1">1x</button>
                    <button class="speed-btn" data-speed="2">2x</button>
                    <button class="speed-btn" data-speed="4">4x</button>
                </div>

                <div class="control-group">
                    <span class="event-info" id="eventInfo">Event: 0/0</span>
                    <select id="eventSelect" class="event-select">
                        <option value="">Select Event...</option>
                    </select>
                    <button id="jumpToEventBtn" class="control-btn" style="display: none;">
                        <i class="fas fa-jump-forward"></i> Jump to Event
                    </button>
                </div>
            </div>

            <!-- Timeline -->
            <div class="timeline-container">
                <input type="range" id="timeline" class="timeline" min="0" max="100" value="0">
                <div class="time-display">
                    <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                </div>
                <div class="timeline-controls">
                    <button id="setStartBtn" class="timeline-btn">
                        <i class="fas fa-play"></i> Set Start
                    </button>
                    <button id="setEndBtn" class="timeline-btn">
                        <i class="fas fa-stop"></i> Set End
                    </button>
                    <button id="spliceBtn" class="timeline-btn primary">
                        <i class="fas fa-cut"></i> Splice Clip
                    </button>
                </div>
            </div>

            <!-- Video Grid -->
            <div class="video-grid" id="videoGrid">
                <!-- Videos will be dynamically added here -->
            </div>
            
            <!-- Download Overlay -->
            <div class="download-overlay" id="downloadOverlay" style="display: none;">
                <div class="download-panel">
                    <h3>Download Video</h3>
                    <div class="download-info">
                        <span id="downloadFileName">video.mp4</span>
                        <span id="downloadCamera">Camera: Front</span>
                    </div>
                    <div class="download-actions">
                        <button id="downloadBtn" class="download-btn">
                            <i class="fas fa-download"></i> Download Video
                        </button>
                        <button id="closeDownloadBtn" class="close-btn">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Overlay -->
            <div class="progress-overlay" id="progressOverlay" style="display: none;">
                <div class="progress-panel">
                    <div class="progress-header">
                        <i class="fas fa-cog fa-spin"></i>
                        <h3 id="progressTitle">Processing Video</h3>
                    </div>
                    <div class="progress-content">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="progress-details" id="progressDetails">
                            <span id="progressStatus">Initializing...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Info -->
            <div class="video-info">
                <div class="info-item">
                    <span class="label">Files loaded:</span>
                    <span id="fileCount">0</span>
                </div>
                <div class="info-item">
                    <span class="label">Events detected:</span>
                    <span id="eventCount">0</span>
                </div>
                <div class="info-item">
                    <span class="label">Custom clips:</span>
                    <span id="clipCount">0</span>
                </div>
            </div>
            
            <!-- Custom Clips Section -->
            <div class="custom-clips" id="customClips" style="display: none;">
                <h3><i class="fas fa-cut"></i> Custom Clips</h3>
                <div class="clips-container" id="clipsContainer">
                    <!-- Custom clips will be added here -->
                </div>
                <div class="combine-controls">
                    <button id="selectClipsBtn" class="combine-btn">
                        <i class="fas fa-check-square"></i> Select Clips
                    </button>
                    <button id="combineBtn" class="combine-btn primary" style="display: none;">
                        <i class="fas fa-link"></i> Combine Selected
                    </button>
                </div>
            </div>

            <!-- Event Combination Section -->
            <div class="event-combination" id="eventCombination" style="display: none;">
                <h3><i class="fas fa-layer-group"></i> Event Combination</h3>
                <p class="section-description">Select multiple events to combine them into a single downloadable compilation.</p>
                
                <div class="event-selection-controls">
                    <button id="selectEventsBtn" class="combine-btn">
                        <i class="fas fa-check-square"></i> Select Events
                    </button>
                    <button id="combineEventsBtn" class="combine-btn primary" style="display: none;">
                        <i class="fas fa-layer-group"></i> Combine Selected Events
                    </button>
                    <button id="clearEventSelectionBtn" class="combine-btn secondary" style="display: none;">
                        <i class="fas fa-times"></i> Clear Selection
                    </button>
                </div>

                <div class="selected-events-container" id="selectedEventsContainer" style="display: none;">
                    <h4>Selected Events:</h4>
                    <div class="selected-events-list" id="selectedEventsList">
                        <!-- Selected events will be listed here -->
                    </div>
                </div>

                <div class="combined-events-container" id="combinedEventsContainer" style="display: none;">
                    <h4>Combined Events:</h4>
                    <div class="combined-events-list" id="combinedEventsList">
                        <!-- Combined events will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> How to Use</h3>
            <ol>
                <li>Insert your TeslaCam USB drive into your computer</li>
                <li>Click "Select Directory" to choose the entire TeslaCam folder or subdirectories (RecentClips, SavedClips, SentryClips)</li>
                <li>Alternatively, click "Select Video Files" to choose individual video files</li>
                <li>You can also drag and drop entire folders or individual files</li>
                <li>Videos will automatically play in your browser</li>
                <li>Use the controls to navigate between events and adjust playback speed</li>
                <li>Click on any video to enlarge it</li>
            </ol>
            
            <div class="offline-note">
                <strong>💡 Offline Tip:</strong> This app works offline! After your first visit, you can disconnect from the internet and still access the app interface.
            </div>
            
            <div class="browser-note">
                <strong>Note:</strong> For best compatibility with H.265 videos, use Safari or Firefox browsers.
            </div>
        </div>
    </div>
    
    <!-- PWA Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-prompt-content">
            <div>
                <i class="fas fa-download"></i>
                <span>Install TeslaCam Video Player for quick access</span>
            </div>
            <div>
                <button class="install-btn" id="installBtn">
                    <i class="fas fa-plus"></i> Install
                </button>
                <button class="dismiss-btn" id="dismissBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Manual Install Button (for testing) -->
    <div class="manual-install" id="manualInstall" style="display: none;">
        <button class="manual-install-btn" onclick="showManualInstallInfo()">
            <i class="fas fa-info-circle"></i> PWA Install Info
        </button>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 TeslaCam Video Player. Built with ❤️ for Tesla owners.</p>
            <p>Inspired by and credits to <a href="https://sentrycam.video" target="_blank" rel="noopener">sentrycam.video</a> - the original TeslaCam web player.</p>
            <div class="footer-links">
                <a href="https://github.com/ablax/teslaview" target="_blank" rel="noopener" class="github-link">
                    <i class="fab fa-github"></i> View on GitHub
                </a>
            </div>
            <p class="disclaimer">This application is not affiliated with Tesla Motors, Inc. TESLA and TESLA MOTORS are trademarks of Tesla Motors, Inc.</p>
        </div>
    </footer>

    <script src="js/app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // Show update notification
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'update-notification';
            notification.innerHTML = `
                <div class="update-content">
                    <i class="fas fa-download"></i>
                    <span>New version available! Refresh to update.</span>
                    <button onclick="location.reload()" class="update-btn">
                        <i class="fas fa-sync-alt"></i> Update
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 10000);
        }

        // Handle offline/online status
        window.addEventListener('online', () => {
            document.body.classList.remove('offline');
            showStatusMessage('Back online', 'success');
        });

        window.addEventListener('offline', () => {
            document.body.classList.add('offline');
            showStatusMessage('You are offline - app will work with cached content', 'warning');
        });

        function showStatusMessage(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;
            statusDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 3000);
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const dismissBtn = document.getElementById('dismissBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Store the event for later use (custom prompt)
            deferredPrompt = e;
            
            // Don't prevent default - let the native banner show
            // The native banner will show automatically if the user hasn't dismissed it
            
            // Show custom install prompt as fallback after a longer delay
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('installPromptDismissed')) {
                    // Only show custom prompt if native banner hasn't been shown
                    installPrompt.classList.add('show');
                }
            }, 10000); // Longer delay to let native banner show first
        });

        // Check installability on load
        window.addEventListener('load', () => {            
            // Show manual install button if no automatic prompt
            setTimeout(() => {
                if (!deferredPrompt) {
                    document.getElementById('manualInstall').style.display = 'block';
                }
            }, 5000);
        });

        // Manual install info function
        function showManualInstallInfo() {
            const info = `
PWA Install Requirements:
✅ HTTPS or localhost
✅ Valid manifest.json
✅ Service worker registered
✅ At least one icon (192x192 or 512x512)
✅ display: standalone in manifest
✅ beforeinstallprompt event

Current Status:
- Service Worker: ${'serviceWorker' in navigator ? '✅' : '❌'}
- Manifest: ${document.querySelector('link[rel="manifest"]') ? '✅' : '❌'}
- Icons: ${document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]').length > 0 ? '✅' : '❌'}
- HTTPS/localhost: ${window.location.protocol === 'https:' || window.location.hostname === 'localhost' ? '✅' : '❌'}

To install manually:
1. Chrome: Click the install icon in address bar
2. Safari: Share > Add to Home Screen
3. Firefox: Click the install icon in address bar
            `;
            alert(info);
        }

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                installPrompt.classList.remove('show');
            }
        });

        dismissBtn.addEventListener('click', () => {
            installPrompt.classList.remove('show');
            localStorage.setItem('installPromptDismissed', 'true');
        });

        // Hide install prompt if app is already installed
        window.addEventListener('appinstalled', () => {
            installPrompt.classList.remove('show');
            deferredPrompt = null;
            showStatusMessage('TeslaCam Video Player installed successfully!', 'success');
        });

        // iOS PWA specific handling
        function checkIOSPWA() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone === true;
            
            if (isIOS && isStandalone) {
                document.body.classList.add('ios-pwa');
            }
            
            // Check if service worker is registered
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                });
            }
        }

        // Check on load
        window.addEventListener('load', checkIOSPWA);
    </script>
</body>
</html> 